name: release

on:
  push:
    tags: [ 'v*' ]

permissions:
  contents: write
  pull-requests: read

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 50

      - name: Validate semantic version format
        timeout-minutes: 1
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}

          # Full semver validation with optional prerelease and build metadata
          if ! [[ $TAG =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$ ]]; then
            echo "ERROR: Invalid semantic version format: $TAG"
            echo "Expected format: v1.2.3 or v1.2.3-alpha.1 or v1.2.3+build.1"
            exit 1
          fi

          # Detect prerelease (versions with hyphen suffix like alpha, beta, rc)
          if [[ $TAG =~ ^[0-9]+\.[0-9]+\.[0-9]+- ]]; then
            PRERELEASE="true"
            echo "✓ Detected prerelease version: $TAG"
          else
            PRERELEASE="false"
            echo "✓ Detected stable release version: $TAG"
          fi

          # Export for use in later steps
          echo "VERSION=$TAG" >> $GITHUB_ENV
          echo "PRERELEASE=$PRERELEASE" >> $GITHUB_ENV
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT

      - name: Create GitHub release
        timeout-minutes: 2
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: false
          prerelease: ${{ env.PRERELEASE }}